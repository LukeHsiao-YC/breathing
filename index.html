<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¿«æ¨‚å‘¼å¸å°æ°£çƒ - å…’ç«¥è…¹å¼å‘¼å¸å¼•å°</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Zen+Maru+Gothic:wght@400;700&display=swap');

        body {
            font-family: 'Zen Maru Gothic', sans-serif;
            background-color: #ecfccb; /* Lime-100 è‡ªç„¶è‰åœ°è‰² */
            background-image: radial-gradient(#d9f99d 1px, transparent 1px);
            background-size: 20px 20px;
            /* å…è¨± body åœ¨å…§å®¹éå¤šæ™‚æ²å‹•ï¼Œé˜²æ­¢è¢«åˆ‡æ‰ */
            overflow: auto; 
        }

        /* æ°£çƒå‹•ç•«èˆ‡æ¨£å¼ */
        .balloon-container {
            position: relative;
            width: 200px;
            height: 200px;
            display: flex;
            justify-content: center;
            align-items: center;
        }

        .balloon {
            width: 140px; /* ç¨å¾®ç¸®å°æ°£çƒä»¥é©æ‡‰ç·Šæ¹Šç‰ˆé¢ */
            height: 140px;
            /* æ”¹ç‚ºæ›´è‡ªç„¶çš„ç²‰æ©˜è‰²/èŠ±æœµè‰² */
            background: radial-gradient(circle at 30% 30%, #fca5a5, #ef4444); 
            border-radius: 50%;
            box-shadow: 0 10px 25px rgba(239, 68, 68, 0.3);
            position: relative;
            transition: transform 0.5s ease; 
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10;
            will-change: transform;
        }

        /* æ°£çƒçš„è‡‰éƒ¨è¡¨æƒ… */
        .face {
            position: relative;
            width: 60%;
            top: -10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .eye {
            width: 15px;
            height: 15px;
            background-color: #333;
            border-radius: 50%;
            animation: blink 3s infinite;
        }

        .mouth {
            position: absolute;
            bottom: -20px;
            left: 50%;
            transform: translateX(-50%);
            width: 20px;
            height: 10px;
            border-bottom: 3px solid #333;
            border-radius: 0 0 15px 15px;
            transition: all 0.3s ease;
        }

        /* è…®ç´… */
        .cheek {
            position: absolute;
            top: 20px;
            width: 20px;
            height: 10px;
            background-color: rgba(255, 255, 255, 0.5);
            border-radius: 50%;
        }
        .cheek.left { left: -5px; }
        .cheek.right { right: -5px; }

        /* è¡¨æƒ…è®ŠåŒ– */
        .balloon.inhale .mouth {
            width: 30px;
            height: 30px;
            background-color: #333;
            border-radius: 50%;
            border: none;
        }

        .balloon.hold .eye {
            height: 2px; /* é–‰çœ¼äº«å— */
            margin-top: 7px;
            animation: none; /* é–‰çœ¼æ™‚ä¸çœ¨çœ¼ */
        }

        .balloon.exhale .mouth {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background-color: #333;
            border: none;
        }
        
        /* å†æ¬¡æ†‹æ°£æ™‚çš„è¡¨æƒ… - å¹³éœ */
        .balloon.empty-hold .eye {
            width: 15px;
            height: 15px;
            border-radius: 50%;
            background-color: #333;
        }
        .balloon.empty-hold .mouth {
            width: 15px;
            height: 2px;
            border-radius: 0;
            background-color: #333;
            border: none;
        }

        @keyframes blink {
            0%, 90%, 100% { transform: scaleY(1); }
            95% { transform: scaleY(0.1); }
        }

        /* ç²’å­å‹•ç•« */
        .particle {
            position: absolute;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 50%;
            pointer-events: none;
            opacity: 0;
            z-index: 50;
        }

        @keyframes floatUp {
            0% { transform: translateY(0) scale(1); opacity: 0.8; }
            100% { transform: translateY(-100px) scale(0); opacity: 0; }
        }

        /* è‡ªå®šç¾©æ»‘æ¡¿æ¨£å¼ */
        input[type=range] {
            -webkit-appearance: none; 
            background: transparent; 
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #ec4899;
            cursor: pointer;
            margin-top: -8px; 
            box-shadow: 0 1px 3px rgba(0,0,0,0.3);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #e5e7eb;
            border-radius: 2px;
        }
        
        /* è‡ªå®šç¾©æ²è»¸ */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
        }
        .custom-scrollbar::-webkit-scrollbar-track {
            background: transparent;
        }
        .custom-scrollbar::-webkit-scrollbar-thumb {
            background-color: rgba(156, 163, 175, 0.5);
            border-radius: 20px;
        }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4 py-8">

    <!-- è¨­å®šé¢æ¿ (Modal) -->
    <div id="settings-modal" class="fixed inset-0 bg-black/50 z-50 hidden flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white rounded-3xl p-6 w-11/12 max-w-sm shadow-2xl transform transition-all scale-100">
            <h3 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                <i class="fas fa-sliders-h mr-2 text-pink-500"></i> èª¿æ•´å‘¼å¸ç¯€å¥
            </h3>
            
            <div class="space-y-4">
                <!-- å¸æ°£ -->
                <div>
                    <div class="flex justify-between text-sm font-bold text-gray-600 mb-1">
                        <span>ğŸŒ¸ å¸æ°£ (Inhale)</span>
                        <span id="val-inhale" class="text-pink-500">4ç§’</span>
                    </div>
                    <input type="range" id="input-inhale" min="4" max="6" value="4" step="1" class="w-full">
                </div>

                <!-- æ†‹æ°£ -->
                <div>
                    <div class="flex justify-between text-sm font-bold text-gray-600 mb-1">
                        <span>ğŸ¦‹ æ†‹æ°£ (Hold)</span>
                        <span id="val-hold" class="text-pink-500">2ç§’</span>
                    </div>
                    <input type="range" id="input-hold" min="2" max="4" value="2" step="1" class="w-full">
                </div>

                <!-- åæ°£ -->
                <div>
                    <div class="flex justify-between text-sm font-bold text-gray-600 mb-1">
                        <span>ğŸƒ åæ°£ (Exhale)</span>
                        <span id="val-exhale" class="text-pink-500">7ç§’</span>
                    </div>
                    <input type="range" id="input-exhale" min="6" max="8" value="7" step="1" class="w-full">
                </div>

                <!-- å†æ¬¡æ†‹æ°£ -->
                <div>
                    <div class="flex justify-between text-sm font-bold text-gray-600 mb-1">
                        <span>âœ¨ åœé “ (Rest)</span>
                        <span id="val-empty" class="text-pink-500">0ç§’</span>
                    </div>
                    <input type="range" id="input-empty" min="0" max="2" value="0" step="1" class="w-full">
                </div>
            </div>

            <button onclick="saveSettings()" class="mt-6 w-full bg-pink-500 hover:bg-pink-600 text-white font-bold py-3 rounded-xl transition shadow-lg">
                ç¢ºèªè¨­å®š
            </button>
        </div>
    </div>

    <!-- ä¸»å¡ç‰‡ -->
    <div class="bg-white/90 backdrop-blur-md rounded-3xl shadow-2xl p-6 md:p-8 max-w-md w-full text-center border-4 border-white relative overflow-y-auto max-h-[90vh] custom-scrollbar">
        
        <!-- è¨­å®šæŒ‰éˆ•èˆ‡æç¤º -->
        <div class="absolute top-4 right-4 z-20 flex items-center">
            <span class="text-[10px] text-gray-400 mr-2 bg-white/60 px-2 py-1 rounded-md backdrop-blur-sm shadow-sm">
                å¯ä»¥ä¾æ“šä½ çš„ç‹€æ³èª¿æ•´å‘¼å¸ç§’æ•¸
            </span>
            <!-- è²éŸ³æŒ‰éˆ• -->
            <button onclick="toggleSound()" class="text-gray-400 hover:text-pink-500 transition p-2 mr-1" title="é–‹é—œè²éŸ³">
                <i id="sound-icon" class="fas fa-volume-up text-xl"></i>
            </button>
            <!-- è¨­å®šæŒ‰éˆ• -->
            <button onclick="openSettings()" class="text-gray-400 hover:text-gray-600 transition p-2">
                <i class="fas fa-cog text-xl"></i>
            </button>
        </div>

        <!-- é ‚éƒ¨æ¨™é¡Œèˆ‡è£é£¾ -->
        <div class="mb-2 mt-10 relative z-10">
            <h1 class="text-3xl font-bold text-gray-800 tracking-wider mb-2">æ²’äº‹ï¼Œæ”¾è¼•é¬†</h1>
            <p class="text-gray-500 text-sm px-4 leading-relaxed">ç·´ç¿’è…¹å¼å‘¼å¸ï¼Œç·©è§£ç·Šç¹ƒçš„æƒ…ç·’ã€‚<br>ç¾åœ¨ï¼Œæƒ³åƒè‡ªå·±ç«™åœ¨ä¸€ç‰‡é–‹æ»¿èŠ±çš„åŸé‡ï¼Œ<br>è·Ÿè‘—ç¯€å¥å¸æ°£åæ°£</p>
        </div>

        <!-- é€²åº¦æŒ‡ç¤ºå™¨ (å‹•æ…‹ç”Ÿæˆ) -->
        <div id="dots-container" class="flex justify-center gap-3 mb-4 mt-4 h-4">
            <!-- JS will populate this -->
        </div>

        <!-- æ ¸å¿ƒå‹•ç•«å€ -->
        <div class="h-56 flex justify-center items-center relative mb-4">
            <!-- è£é£¾åœˆåœˆ (èƒŒæ™¯) -->
            <div id="ripple" class="absolute w-40 h-40 border-4 border-pink-200 rounded-full opacity-0"></div>
            
            <div class="balloon-container">
                <div id="balloon" class="balloon">
                    <div class="face">
                        <div class="cheek left"></div>
                        <div class="eye left"></div>
                        <div class="mouth"></div>
                        <div class="eye right"></div>
                        <div class="cheek right"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- æŒ‡ä»¤æ–‡å­—èˆ‡å€’æ•¸ -->
        <div class="h-24 mb-2 relative z-10 flex flex-col justify-center items-center">
            <h2 id="instruction-text" class="text-2xl font-bold text-pink-500 mb-1 transition-all">æº–å‚™å¥½äº†å—ï¼Ÿ</h2>
            <p id="sub-instruction" class="text-gray-500 text-sm mb-2 h-6">æƒ³åƒæˆ‘å€‘åœ¨ä¸€åº§ç¾éº—çš„èŠ±åœ’è£¡</p>
            <div id="timer-display" class="text-6xl font-black text-gray-700 opacity-0 transition-opacity" style="font-variant-numeric: tabular-nums;">0</div>
        </div>

        <!-- æ§åˆ¶æŒ‰éˆ• -->
        <div class="flex gap-4 justify-center relative z-10 w-full mt-2 pb-2">
            <button id="start-btn" onclick="startExercise()" class="bg-gradient-to-r from-green-400 to-emerald-500 hover:from-green-500 hover:to-emerald-600 text-white font-bold py-3 px-8 rounded-full shadow-lg transform transition hover:scale-105 active:scale-95 text-lg w-full max-w-xs flex justify-center items-center">
                <i class="fas fa-leaf mr-2"></i> é–‹å§‹æ·±å‘¼å¸
            </button>
            <button id="stop-btn" onclick="stopExercise()" class="hidden bg-gray-200 hover:bg-gray-300 text-gray-600 font-bold py-3 px-6 rounded-full shadow-md transform transition hover:scale-105 active:scale-95 w-full max-w-xs flex justify-center items-center">
                <i class="fas fa-stop mr-2"></i> åœæ­¢
            </button>
        </div>

        <!-- å®Œæˆæ¬¡æ•¸ -->
        <div class="mt-4 text-sm text-gray-400">
            å·²å®Œæˆå‘¼å¸å¾ªç’°: <span id="cycle-count" class="font-bold text-emerald-500 text-lg">0</span>
        </div>
    </div>

    <script>
        // === é è¨­å‘¼å¸ç¯€å¥ ===
        let CONFIG = {
            inhale: 4,  
            hold: 2,    
            exhale: 7, 
            empty: 0   // åæ°£å¾Œåœé “
        };

        // ç‹€æ…‹è®Šæ•¸
        let isRunning = false;
        let timerInterval = null;
        let cycleCount = 0;
        
        // è²éŸ³ç›¸é—œ
        let isSoundEnabled = true;
        let audioCtx = null;

        // DOM å…ƒç´ å¿«å–
        const balloon = document.getElementById('balloon');
        const instructionText = document.getElementById('instruction-text');
        const subInstruction = document.getElementById('sub-instruction');
        const timerDisplay = document.getElementById('timer-display');
        const startBtn = document.getElementById('start-btn');
        const stopBtn = document.getElementById('stop-btn');
        const cycleCountDisplay = document.getElementById('cycle-count');
        const ripple = document.getElementById('ripple');
        const dotsContainer = document.getElementById('dots-container');
        const soundIcon = document.getElementById('sound-icon');
        
        // Settings Elements
        const settingsModal = document.getElementById('settings-modal');
        const inputs = {
            inhale: document.getElementById('input-inhale'),
            hold: document.getElementById('input-hold'),
            exhale: document.getElementById('input-exhale'),
            empty: document.getElementById('input-empty')
        };
        const displays = {
            inhale: document.getElementById('val-inhale'),
            hold: document.getElementById('val-hold'),
            exhale: document.getElementById('val-exhale'),
            empty: document.getElementById('val-empty')
        };

        // --- è²éŸ³åŠŸèƒ½ (æ¨¡æ“¬é‹¼ç´) ---
        // Cå¤§èª¿éŸ³éšé »ç‡å°ç…§è¡¨ (C4 - F5)
        const SCALE_FREQS = [
            261.63, // C4 (Do) - 0
            293.66, // D4 (Re) - 1
            329.63, // E4 (Mi) - 2
            349.23, // F4 (Fa) - 3
            392.00, // G4 (Sol) - 4
            440.00, // A4 (La) - 5
            493.88, // B4 (Ti) - 6
            523.25, // C5 (Do) - 7
            587.33, // D5 (Re) - 8
            659.25, // E5 (Mi) - 9
            698.46, // F5 (Fa) - 10
            783.99  // G5 (Sol) - 11
        ];

        function toggleSound() {
            isSoundEnabled = !isSoundEnabled;
            // æ›´æ–°åœ–ç¤º
            if (isSoundEnabled) {
                soundIcon.classList.remove('fa-volume-mute');
                soundIcon.classList.add('fa-volume-up');
                soundIcon.parentElement.classList.add('text-gray-400');
                soundIcon.parentElement.classList.remove('text-red-400');
                
                // å˜—è©¦åˆå§‹åŒ–éŸ³æ•ˆç’°å¢ƒ
                initAudioContext();
            } else {
                soundIcon.classList.remove('fa-volume-up');
                soundIcon.classList.add('fa-volume-mute');
                soundIcon.parentElement.classList.remove('text-gray-400');
                soundIcon.parentElement.classList.add('text-red-400');
            }
        }

        function initAudioContext() {
            if (!audioCtx) {
                const AudioContext = window.AudioContext || window.webkitAudioContext;
                audioCtx = new AudioContext();
            }
            if (audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
        }

        // æ ¹æ“šéšæ®µèˆ‡æ™‚é–“è¨ˆç®—éŸ³é«˜
        function getNoteFrequency(phase, duration, timeLeft) {
            let index = 0;
            if (phase === 'inhale') {
                // å¸æ°£ï¼šéŸ³éšä¸Šè¡Œ (0, 1, 2, 3...)
                // timeLeft å€’æ•¸: 4, 3, 2, 1 -> index: 0, 1, 2, 3
                index = duration - timeLeft;
            } else if (phase === 'exhale') {
                // åæ°£ï¼šéŸ³éšä¸‹è¡Œ (...3, 2, 1, 0)
                // timeLeft å€’æ•¸: 7, 6, 5... 1 -> index: 6, 5, 4... 0
                index = timeLeft - 1;
            } else if (phase === 'hold') {
                // æ†‹æ°£ï¼šç¶­æŒè¼ƒé«˜éŸ³ (Sol)
                index = 4; // G4
            } else if (phase === 'empty-hold') {
                // åœé “ï¼šç¶­æŒä½éŸ³ (Do)
                index = 0; // C4
            }
            
            // ç¢ºä¿ç´¢å¼•åœ¨ç¯„åœå…§
            if (index < 0) index = 0;
            if (index >= SCALE_FREQS.length) index = SCALE_FREQS.length - 1;
            
            return SCALE_FREQS[index];
        }

        function playPianoSound(freq) {
            if (!isSoundEnabled) return;
            if (!audioCtx) initAudioContext();
            if (audioCtx.state === 'suspended') audioCtx.resume();

            const t = audioCtx.currentTime;
            
            // ä½¿ç”¨å‚³å…¥çš„é »ç‡ï¼Œè‹¥ç„¡å‰‡é è¨­ G4
            const fundamentalFreq = freq || 392.00; 

            // è¼”åŠ©å‡½æ•¸ï¼šå»ºç«‹å–®å€‹æ³›éŸ³
            const playOscillator = (type, frequency, gainVal, decay) => {
                const osc = audioCtx.createOscillator();
                const gain = audioCtx.createGain();
                osc.type = type;
                osc.frequency.setValueAtTime(frequency, t);
                
                // Envelope (ADSR ç°¡åŒ–ç‰ˆ: Attack, Decay)
                gain.gain.setValueAtTime(0, t);
                gain.gain.linearRampToValueAtTime(gainVal, t + 0.05); // Attack: ç¨å¾®æŸ”å’Œä¸€é»
                gain.gain.exponentialRampToValueAtTime(0.01, t + decay); // Decay

                osc.connect(gain);
                gain.connect(audioCtx.destination);
                osc.start(t);
                osc.stop(t + decay);
            };

            // 1. åŸºé » (ä¸»éŸ³)
            playOscillator('sine', fundamentalFreq, 0.5, 1.5);
            
            // 2. ç¬¬äºŒæ³›éŸ³ (å…«åº¦éŸ³)
            playOscillator('sine', fundamentalFreq * 2, 0.15, 1.0);
            
            // 3. ç¬¬ä¸‰æ³›éŸ³ (å¢åŠ äº®åº¦)
            playOscillator('triangle', fundamentalFreq, 0.05, 0.8);
        }

        // --- è¨­å®šç›¸é—œåŠŸèƒ½ ---
        function openSettings() {
            if (isRunning) stopExercise();
            settingsModal.classList.remove('hidden');
        }

        function saveSettings() {
            CONFIG.inhale = parseInt(inputs.inhale.value);
            CONFIG.hold = parseInt(inputs.hold.value);
            CONFIG.exhale = parseInt(inputs.exhale.value);
            CONFIG.empty = parseInt(inputs.empty.value);
            
            settingsModal.classList.add('hidden');
            renderDots(); // é‡æ–°ç¹ªè£½é»é»ï¼ˆå¯èƒ½è®Šæˆ4é¡†ï¼‰
            resetUI(); // æ›´æ–°ä»‹é¢æ–‡å­—
        }

        // ç¶å®šæ»‘æ¡¿æ•¸å€¼é¡¯ç¤º
        Object.keys(inputs).forEach(key => {
            inputs[key].addEventListener('input', (e) => {
                displays[key].textContent = e.target.value + "ç§’";
            });
        });

        // å‹•æ…‹ç”Ÿæˆé€²åº¦é»
        function renderDots() {
            dotsContainer.innerHTML = '';
            // åŸºç¤3éšæ®µ + å¯é¸ç¬¬4éšæ®µ
            const totalSteps = CONFIG.empty > 0 ? 4 : 3;
            
            for (let i = 0; i < totalSteps; i++) {
                const dot = document.createElement('div');
                dot.id = `step-dot-${i}`;
                dot.className = "w-3 h-3 rounded-full bg-gray-300 transition-all duration-300";
                dotsContainer.appendChild(dot);
            }
        }

        // --- ä¸»ç¨‹å¼é‚è¼¯ ---

        function resetUI() {
            clearInterval(timerInterval);
            isRunning = false;
            
            balloon.style.transition = 'transform 0.5s ease-out';
            balloon.style.transform = 'scale(1)';
            balloon.classList.remove('inhale', 'hold', 'exhale', 'empty-hold');
            
            instructionText.textContent = "æº–å‚™å¥½äº†å—ï¼Ÿ";
            instructionText.className = "text-2xl font-bold text-gray-700 mb-1";
            subInstruction.textContent = "æƒ³åƒæˆ‘å€‘åœ¨ä¸€åº§ç¾éº—çš„èŠ±åœ’è£¡";
            
            timerDisplay.classList.add('opacity-0');
            timerDisplay.textContent = "0";
            
            startBtn.classList.remove('hidden');
            stopBtn.classList.add('hidden');
            
            // é‡ç½®é»é»é¡è‰²
            const dots = dotsContainer.children;
            for(let dot of dots) {
                dot.className = "w-3 h-3 rounded-full bg-gray-300 transition-all duration-300";
            }
            
            ripple.style.animation = 'none';
            ripple.style.opacity = '0';
        }

        function startExercise() {
            if (isRunning) return;
            
            // åˆå§‹åŒ–éŸ³æ•ˆ (å› ç‚ºç€è¦½å™¨é™åˆ¶ï¼Œå¿…é ˆåœ¨ä½¿ç”¨è€…äº’å‹•æ™‚è§¸ç™¼)
            initAudioContext();
            
            isRunning = true;
            startBtn.classList.add('hidden');
            stopBtn.classList.remove('hidden');
            timerDisplay.classList.remove('opacity-0');
            runCycle();
        }

        function stopExercise() {
            resetUI();
        }

        async function runCycle() {
            if (!isRunning) return;

            // 1. å¸æ°£ (Inhale) - èèŠ±é¦™
            await runPhase('inhale', CONFIG.inhale, 
                "é¼»å­æ…¢æ…¢å¸æ°£...", 
                "è®“è‚šå­è‡ªç„¶éš†èµ·ï¼Œåƒèä¸€æœµå¾ˆé¦™çš„èŠ± ğŸŒ¸", 
                "text-rose-500", 
                0
            );
            
            if (!isRunning) return;

            // 2. æ†‹æ°£ (Hold) - è´è¶åœ
            await runPhase('hold', CONFIG.hold, 
                "åœä½ä¸€ä¸‹...", 
                "åƒè´è¶åœåœ¨èŠ±ç“£ä¸Šä¸€æ¨£å®‰éœ ğŸ¦‹", 
                "text-purple-500", 
                1
            );
            
            if (!isRunning) return;

            // 3. åæ°£ (Exhale) - å¾®é¢¨å¹
            await runPhase('exhale', CONFIG.exhale, 
                "å˜´å·´è¼•è¼•åæ°£...", 
                "è‚šå­é€æ¼¸å¹³å¦ï¼Œåƒå¾®é¢¨å¹éè‰åœ° ğŸƒ", 
                "text-emerald-500", 
                2
            );
            
            if (!isRunning) return;

            // 4. (é¸å¡«) å†æ¬¡æ†‹æ°£ (Empty Hold) - ç­‰å¾…é¢¨èµ·
            if (CONFIG.empty > 0) {
                await runPhase('empty-hold', CONFIG.empty,
                    "éœéœç­‰å¾…...",
                    "ç­‰å¾…é¢¨å†æ¬¡å¹èµ· âœ¨",
                    "text-blue-400",
                    3
                );
            }

            if (!isRunning) return;

            // å¾ªç’°å®Œæˆ
            cycleCount++;
            cycleCountDisplay.textContent = cycleCount;
            createConfetti();
            runCycle();
        }

        function runPhase(phase, duration, mainText, subText, colorClass, dotIndex) {
            return new Promise(resolve => {
                let timeLeft = duration;

                // æ›´æ–°æ–‡å­—
                instructionText.textContent = mainText;
                instructionText.className = `text-3xl font-bold mb-1 transition-colors duration-300 ${colorClass}`;
                subInstruction.textContent = subText;
                timerDisplay.textContent = timeLeft;
                timerDisplay.className = `text-6xl font-black transition-colors duration-300 ${colorClass}`;

                // æ’­æ”¾ç¬¬ä¸€è²é‹¼ç´ (æ ¹æ“šç•¶ä¸‹æ™‚é–“é»)
                let freq = getNoteFrequency(phase, duration, timeLeft);
                playPianoSound(freq);

                // æ›´æ–°é»é»
                const dots = dotsContainer.children;
                for (let i = 0; i < dots.length; i++) {
                    const bgClass = colorClass.replace('text-', 'bg-');
                    const ringClass = colorClass.replace('text-', 'ring-');
                    
                    if (i === dotIndex) {
                        dots[i].className = `w-4 h-4 rounded-full ${bgClass} ring-2 ring-offset-2 ${ringClass} transition-all duration-300`;
                    } else {
                        dots[i].className = "w-3 h-3 rounded-full bg-gray-200 transition-all duration-300";
                    }
                }

                // æ›´æ–°å‹•ç•«
                balloon.style.transition = `transform ${duration}s linear`;
                balloon.classList.remove('inhale', 'hold', 'exhale', 'empty-hold');
                balloon.classList.add(phase);

                if (phase === 'inhale') {
                    balloon.style.transform = 'scale(1.6)';
                    ripple.style.animation = `ping ${duration}s cubic-bezier(0, 0, 0.2, 1) infinite`; 
                    ripple.style.opacity = '0.5';
                } else if (phase === 'hold') {
                    balloon.style.transform = 'scale(1.6)';
                    ripple.style.animation = 'none';
                    ripple.style.opacity = '0';
                } else if (phase === 'exhale') {
                    balloon.style.transform = 'scale(1)';
                    ripple.style.animation = 'none';
                    ripple.style.opacity = '0';
                } else if (phase === 'empty-hold') {
                    balloon.style.transform = 'scale(1)'; // ä¿æŒå°
                    ripple.style.animation = 'none';
                    ripple.style.opacity = '0';
                }

                // å€’æ•¸è¨ˆæ™‚
                timerInterval = setInterval(() => {
                    timeLeft--;
                    timerDisplay.textContent = timeLeft;
                    
                    // å€’æ•¸æ™‚æ’­æ”¾é‹¼ç´è²éŸ³ (é™¤äº†æœ€å¾Œè®Šæˆ0çš„é‚£ä¸€åˆ»)
                    if (timeLeft > 0) {
                        let nextFreq = getNoteFrequency(phase, duration, timeLeft);
                        playPianoSound(nextFreq);
                    }

                    if (timeLeft <= 0) {
                        clearInterval(timerInterval);
                        resolve();
                    }
                }, 1000);
            });
        }

        function createConfetti() {
            const container = document.body;
            const colors = ['#fca5a5', '#bef264', '#67e8f9', '#c4b5fd', '#fcd34d'];
            
            for(let i=0; i<15; i++) {
                const conf = document.createElement('div');
                conf.classList.add('particle');
                const left = 50 + (Math.random() * 40 - 20);
                conf.style.left = left + '%';
                conf.style.top = '60%';
                const size = (Math.random() * 8 + 6) + 'px';
                conf.style.width = size;
                conf.style.height = size;
                conf.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
                const duration = 1 + Math.random() * 1.5;
                conf.style.animation = `floatUp ${duration}s ease-out forwards`;
                container.appendChild(conf);
                setTimeout(() => conf.remove(), duration * 1000);
            }
        }

        // åˆå§‹åŒ–
        renderDots();
        resetUI();

    </script>
</body>
</html>
